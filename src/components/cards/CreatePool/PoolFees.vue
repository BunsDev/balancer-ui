<script lang="ts" setup>
import useWeb3 from '@/services/web3/useWeb3';
import { computed, defineComponent, ref } from 'vue';
import BalProgressBar from '@/components/_global/BalProgressBar/BalProgressBar.vue';
import useNumbers from '@/composables/useNumbers';
import BalStack from '@/components/_global/BalStack/BalStack.vue';
import { isRequired } from '@/lib/utils/validations';
import { useI18n } from 'vue-i18n';
import { isAddress } from '@ethersproject/address';
import BalTextInput from '@/components/_global/BalTextInput/BalTextInput.vue';
import usePoolCreation from '@/composables/pools/usePoolCreation';

const emit = defineEmits(['nextStep']);

const { fNum } = useNumbers();
const {
  initialFee,
  feeManagementType,
  setFeeManagement,
  thirdPartyFeeController
} = usePoolCreation();
const { t } = useI18n();
const { account } = useWeb3();
const isCustomFee = ref(false);
const isValidAddress = ref(true);

function onFixedInput(val: string): void {
  initialFee.value = '0';
  initialFee.value = val;
  isCustomFee.value = false;
}

function onCustomInput(val: string): void {
  initialFee.value = (Number(val) / 100).toString();
  isCustomFee.value = true;
}

function onCustomAddressInput(val: string) {
  if (isAddress(val)) {
    isValidAddress.value = true;
    return;
  }
  isValidAddress.value = false;
}

const FIXED_FEE_OPTIONS = ['0.0005', '0.003', '0.01'];
const feeOptions = FIXED_FEE_OPTIONS.map(option => {
  return {
    label: fNum(option, null, { format: '0.0%' }),
    value: option
  };
});

const customInputClasses = computed(() => ({
  'border border-blue-500 text-blue-500': isCustomFee.value,
  'border dark:border-gray-900': !isCustomFee.value
}));

const addressInputClasses = computed(() => ({
  border: isValidAddress.value,
  'border border-red-400': !isValidAddress.value
}));

const { userNetworkConfig } = useWeb3();

const onChangeFeeManagementType = (val: boolean) => {
  if (val) {
    setFeeManagement('fixed');
  }
};
</script>

<template>
  <BalCard>
    <BalStack vertical>
      <BalStack vertical spacing="xs">
        <span class="text-sm text-gray-700">{{ userNetworkConfig?.name }}</span>
        <h5 class="font-bold">Set pool fees</h5>
      </BalStack>
      <BalStack vertical spacing="sm">
        <div>
          <h6 class="mb-1">Initial swap fee</h6>
          <p class="text-gray-600">
            0.30% is best for most weighted pool with established tokens. Go
            higher for more exotic pairs.
          </p>
        </div>
        <BalStack spacing="xs" horizontal>
          <BalBtnGroup
            :options="feeOptions"
            v-model="initialFee"
            @update:modelValue="onFixedInput"
          />
          <div :class="['custom-input', customInputClasses]">
            <input
              class="w-12 text-right bg-transparent"
              v-model="fee"
              placeholder="0.1"
              type="number"
              step="any"
              min="0"
              @update:modelValue="onCustomInput"
            />
            <div class="px-1">
              %
            </div>
          </div>
        </BalStack>
      </BalStack>
      <BalStack horizontal spacing="none" align="center">
        <BalCheckbox
          @update:modelValue="onChangeFeeManagementType"
          name="areFeesGovernanceManaged"
          size="sm"
          :label="$t('createAPool.governanceFees')"
          noMargin
        />
        <BalTooltip
          :text="$t('createAPool.governanceFeesTooltip')"
          icon-size="sm"
          class="ml-2"
        />
      </BalStack>
      <BalStack
        vertical
        spacing="xs"
        v-if="['address', 'fixed', 'self'].includes(feeManagementType)"
      >
        <h6 class="mb-1">Alternative fee management options</h6>
        <BalRadio
          v-model="feeManagementType"
          value="fixed"
          name="feeManagementOptions"
        >
          <template v-slot:label>
            <span>
              {{ $t('createAPool.fixedFeeRadioLabel') }}
            </span>
          </template>
        </BalRadio>
        <BalRadio
          v-model="feeManagementType"
          value="self"
          name="feeManagementOptions"
        >
          <template v-slot:label>
            <span>
              {{ $t('createAPool.dynamicFeeRadioLabel') }}
            </span>
          </template>
        </BalRadio>
      </BalStack>
      <BalStack
        vertical
        spacing="xs"
        v-if="['address', 'self'].includes(feeManagementType)"
      >
        <h6 class="mb-1">Set an address to control fees</h6>
        <BalRadio v-model="feeManagementType" value="self" name="addressOption">
          <template v-slot:label>
            <span>
              {{ $t('createAPool.myAddressOption', [_shorten(account)]) }}
            </span>
          </template>
        </BalRadio>
        <BalRadio
          v-model="feeManagementType"
          value="address"
          name="addressOption"
        >
          <template v-slot:label>
            <span>
              {{ $t('createAPool.customAddressOption') }}
            </span>
          </template>
        </BalRadio>
      </BalStack>
      <BalStack vertical v-if="feeManagementType === 'address'" spacing="xs">
        <h6>{{ $t('createAPool.customAddressTitle') }}</h6>
        <p class="text-gray-600 mb-1">
          {{ $t('createAPool.customAddressInfo') }}
        </p>
        <BalStack vertical spacing="xs">
          <BalTextInput
            v-model="thirdPartyFeeController"
            placeholder="0xBA4...2069"
            type="text"
            @update:modelValue="onCustomAddressInput"
            size="sm"
          />
        </BalStack>
      </BalStack>
      <BalBtn block color="gradient" @click="emit('nextStep')">Next</BalBtn>
    </BalStack>
  </BalCard>
</template>

<style scoped>
.custom-input {
  @apply flex items-center px-1 rounded-lg shadow-inner h-full;
}
</style>
